{"version":3,"file":"subscriptionServices-ByMOGxzj.js","sources":["../../../.svelte-kit/adapter-node/chunks/subscriptionServices.js"],"sourcesContent":["import { p as prisma } from \"./prisma.js\";\nimport { v as verify, i as isAdmin } from \"./loginServices.js\";\nconst DAY_MS = 864e5;\nconst FREE_TCODES = [\"blog\"];\nfunction normTcode(t) {\n  return (t ?? \"\").toString().trim();\n}\nasync function isSubscribed(tcode, token) {\n  const code = (tcode ?? \"\").toString().trim();\n  if (FREE_TCODES.includes(code)) {\n    return { allowed: true, reason: \"free\", userId: null, tcode: code, expiresAt: null, remainingDays: null };\n  }\n  if (!token) {\n    return { allowed: false, reason: \"no-token\", userId: null, tcode: code, expiresAt: null, remainingDays: null };\n  }\n  if (!code) {\n    return { allowed: false, reason: \"no-subscription\", userId: null, tcode: code, expiresAt: null, remainingDays: null };\n  }\n  try {\n    const { user } = await verify(token);\n    if (await isAdmin(token)) {\n      return { allowed: true, reason: \"ok\", userId: user.id, tcode: code, expiresAt: null, remainingDays: null };\n    }\n    const now = Date.now();\n    const sub = await prisma.subscription.findFirst({\n      where: { user_id: user.id, tcode: code },\n      orderBy: { start_date: \"desc\" },\n      select: { start_date: true, duration: true }\n    });\n    if (!sub) {\n      return { allowed: false, reason: \"no-subscription\", userId: user.id, tcode: code, expiresAt: null, remainingDays: null };\n    }\n    const startMs = sub.start_date.getTime();\n    const expiryMs = startMs + sub.duration * DAY_MS;\n    if (now < startMs) {\n      return { allowed: false, reason: \"no-subscription\", userId: user.id, tcode: code, expiresAt: new Date(expiryMs).toISOString(), remainingDays: Math.ceil((expiryMs - now) / DAY_MS) };\n    }\n    if (now >= expiryMs) {\n      return { allowed: false, reason: \"expired\", userId: user.id, tcode: code, expiresAt: new Date(expiryMs).toISOString(), remainingDays: 0 };\n    }\n    const remainingDays = Math.ceil((expiryMs - now) / DAY_MS);\n    return { allowed: true, reason: \"ok\", userId: user.id, tcode: code, expiresAt: new Date(expiryMs).toISOString(), remainingDays };\n  } catch {\n    return { allowed: false, reason: \"invalid-token\", userId: null, tcode: code, expiresAt: null, remainingDays: null };\n  }\n}\nasync function addSubscription(userId, tcode, durationDays, opts = {}) {\n  const uid = (userId ?? \"\").toString().trim();\n  const code = normTcode(tcode);\n  const duration = Number.isFinite(durationDays) ? Math.trunc(durationDays) : NaN;\n  const startDate = opts.startDate instanceof Date ? opts.startDate : /* @__PURE__ */ new Date();\n  if (!uid) throw new Error(\"userId is required\");\n  if (!code) throw new Error(\"tcode is required\");\n  if (!Number.isFinite(duration) || duration < 1) throw new Error(\"duration must be an integer >= 1\");\n  const user = await prisma.user.findUnique({ where: { id: uid }, select: { id: true } });\n  if (!user) throw new Error(\"user not found\");\n  const created = await prisma.subscription.create({\n    data: {\n      user_id: uid,\n      tcode: code,\n      start_date: startDate,\n      duration\n    },\n    select: {\n      id: true,\n      user_id: true,\n      tcode: true,\n      start_date: true,\n      duration: true\n    }\n  });\n  const expiryMs = created.start_date.getTime() + created.duration * DAY_MS;\n  const expiresAt = new Date(expiryMs).toISOString();\n  return {\n    id: created.id,\n    userId: created.user_id,\n    tcode: created.tcode,\n    start_date: created.start_date,\n    duration: created.duration,\n    expiresAt\n  };\n}\nexport {\n  addSubscription as a,\n  isSubscribed as i\n};\n"],"names":[],"mappings":"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"}