{"version":3,"file":"_server-2W7ASMiW.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/admin/upload/_server.js"],"sourcesContent":["import { json } from \"@sveltejs/kit\";\nimport { e as exists, c as createQuestion } from \"../../../../chunks/questionServices.js\";\nconst STATUS = /* @__PURE__ */ new Set([\"draft\", \"ready\", \"published\", \"archived\"]);\nconst toSafeName = (s) => (s || \"\").replace(/\\.json$/i, \"\").trim().toLowerCase().replace(/[^a-z0-9_-]+/g, \"-\").replace(/-+/g, \"-\").replace(/^-|-$/g, \"\");\nasync function POST({ request }) {\n  const form = await request.formData();\n  const tcode = (form.get(\"tcode\") ?? \"\").toString().trim();\n  const chapStr = (form.get(\"chapter\") ?? \"\").toString().trim();\n  const exercise = (form.get(\"exercise\") ?? \"\").toString().trim();\n  if (!tcode || !chapStr || !exercise) {\n    return json({ error: \"Missing required fields: tcode, chapter, exercise\" }, { status: 400 });\n  }\n  const chapter = Number.parseInt(chapStr, 10);\n  if (Number.isNaN(chapter)) {\n    return json({ error: \"chapter must be an integer\" }, { status: 400 });\n  }\n  const description = (form.get(\"description\") ?? \"\").toString().trim() || null;\n  const tagsCsv = (form.get(\"tags\") ?? \"\").toString();\n  const tags = tagsCsv ? tagsCsv.split(\",\").map((s) => s.trim()).filter(Boolean) : [];\n  let status = (form.get(\"status\") ?? \"\").toString().trim();\n  if (status && !STATUS.has(status)) status = \"\";\n  const file = form.get(\"file\");\n  if (!file) return json({ error: \"No file uploaded\" }, { status: 400 });\n  if (!/\\.json$/i.test(file.name || \"\")) {\n    return json({ error: \"Only .json files are allowed\" }, { status: 400 });\n  }\n  const provided = (form.get(\"filename\") ?? \"\").toString().trim();\n  const baseName = toSafeName(provided || file.name);\n  if (!baseName) return json({ error: \"Unable to determine filename\" }, { status: 400 });\n  if (await exists(baseName)) {\n    return json({ error: \"Filename already exists\" }, { status: 409 });\n  }\n  let deck;\n  try {\n    const text = await file.text();\n    deck = JSON.parse(text);\n  } catch {\n    return json({ error: \"Invalid JSON\" }, { status: 400 });\n  }\n  const qName = deck?.name || baseName;\n  const timed = false;\n  try {\n    await createQuestion({\n      filename: baseName,\n      tcode,\n      chapter,\n      exercise,\n      type: \"deck\",\n      name: qName,\n      description,\n      tags,\n      status: status || null,\n      timed,\n      deck\n    });\n    return json({ success: true, filename: baseName });\n  } catch (e) {\n    const msg = e?.message || \"Server error\";\n    if (/P2002/.test(msg)) {\n      return json({ error: \"Filename already exists\" }, { status: 409 });\n    }\n    console.error(\"upload_json error:\", e);\n    return json({ error: msg }, { status: 500 });\n  }\n}\nexport {\n  POST\n};\n"],"names":[],"mappings":"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"}