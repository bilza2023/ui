{"version":3,"file":"8-CRpT67-9.js","sources":["../../../.svelte-kit/adapter-node/entries/pages/admin/subscriptions/_page.server.js","../../../.svelte-kit/adapter-node/nodes/8.js"],"sourcesContent":["import { redirect, error } from \"@sveltejs/kit\";\nimport { p as prisma } from \"../../../../chunks/prisma.js\";\nimport { i as isAdmin } from \"../../../../chunks/loginServices.js\";\nimport { a as addSubscription } from \"../../../../chunks/subscriptionServices.js\";\nimport { l as listTcodes } from \"../../../../chunks/synopsisServices.js\";\nconst DAY_MS = 864e5;\nfunction getToken(event) {\n  const cookie = event.cookies.get(\"token\");\n  if (cookie) return cookie;\n  const auth = event.request.headers.get(\"authorization\");\n  if (auth && auth.startsWith(\"Bearer \")) return auth.slice(7);\n  return null;\n}\nfunction toIso(d) {\n  try {\n    return new Date(d).toISOString();\n  } catch {\n    return null;\n  }\n}\nfunction computeRow(sub) {\n  const start = new Date(sub.start_date);\n  const expiryMs = start.getTime() + sub.duration * DAY_MS;\n  const expiry = new Date(expiryMs);\n  const now = /* @__PURE__ */ new Date();\n  const upcoming = now < start;\n  const expired = now >= expiry;\n  const active = !upcoming && !expired;\n  const remainingDays = active ? Math.ceil((expiryMs - now.getTime()) / DAY_MS) : 0;\n  return {\n    id: sub.id,\n    tcode: sub.tcode,\n    start_date: toIso(start),\n    duration: sub.duration,\n    expiresAt: toIso(expiry),\n    status: upcoming ? \"upcoming\" : expired ? \"expired\" : \"active\",\n    remainingDays\n  };\n}\nasync function requireAdmin(event) {\n  const token = getToken(event);\n  if (!token) throw redirect(302, \"/login\");\n  const ok = await isAdmin(token);\n  if (!ok) throw error(403, \"Forbidden\");\n  return token;\n}\nasync function findUserByEmail(email) {\n  const e = (email ?? \"\").toString().trim().toLowerCase();\n  if (!e) return null;\n  return prisma.user.findUnique({\n    where: { email: e },\n    select: { id: true, email: true, created_at: true }\n  });\n}\nasync function load(event) {\n  await requireAdmin(event);\n  const email = event.url.searchParams.get(\"email\") ?? \"\";\n  const tcodes = await listTcodes();\n  let selectedUser = null;\n  let subscriptions = [];\n  if (email) {\n    const u = await findUserByEmail(email);\n    if (u) {\n      selectedUser = u;\n      const rows = await prisma.subscription.findMany({\n        where: { user_id: u.id },\n        orderBy: [{ tcode: \"asc\" }, { start_date: \"desc\" }],\n        select: { id: true, tcode: true, start_date: true, duration: true }\n      });\n      subscriptions = rows.map(computeRow);\n    }\n  }\n  return {\n    tcodes,\n    selectedEmail: email,\n    selectedUser,\n    subscriptions\n  };\n}\nconst actions = {\n  // Grant a subscription to a user (by email) for a tcode\n  grant: async (event) => {\n    await requireAdmin(event);\n    const data = await event.request.formData();\n    const email = (data.get(\"email\") ?? \"\").toString().trim().toLowerCase();\n    const tcode = (data.get(\"tcode\") ?? \"\").toString().trim();\n    const duration = Number((data.get(\"duration\") ?? \"\").toString().trim());\n    const startRaw = (data.get(\"startDate\") ?? \"\").toString().trim();\n    if (!email) return { ok: false, message: \"Email is required\" };\n    if (!tcode) return { ok: false, message: \"Tcode is required\" };\n    if (!Number.isFinite(duration) || duration < 1) {\n      return { ok: false, message: \"Duration must be an integer â‰¥ 1\" };\n    }\n    const user = await findUserByEmail(email);\n    if (!user) return { ok: false, message: \"User not found\" };\n    const startDate = startRaw ? new Date(startRaw) : /* @__PURE__ */ new Date();\n    if (isNaN(startDate.getTime())) {\n      return { ok: false, message: \"Invalid start date\" };\n    }\n    try {\n      const created = await addSubscription(user.id, tcode, duration, { startDate });\n      return {\n        ok: true,\n        message: `Granted ${tcode} to ${email} for ${duration} day(s).`,\n        created\n      };\n    } catch (e) {\n      return { ok: false, message: e?.message ?? \"Failed to add subscription\" };\n    }\n  }\n};\nexport {\n  actions,\n  load\n};\n","import * as server from '../entries/pages/admin/subscriptions/_page.server.js';\n\nexport const index = 8;\nlet component_cache;\nexport const component = async () => component_cache ??= (await import('../entries/pages/admin/subscriptions/_page.svelte.js')).default;\nexport { server };\nexport const server_id = \"src/routes/admin/subscriptions/+page.server.js\";\nexport const imports = [\"_app/immutable/nodes/8.B7YQ1qls.js\",\"_app/immutable/chunks/MRdXX-TE.js\",\"_app/immutable/chunks/ReGSdYAt.js\",\"_app/immutable/chunks/IHki7fMi.js\",\"_app/immutable/chunks/OBsGlrAT.js\",\"_app/immutable/chunks/C8m_8st_.js\"];\nexport const stylesheets = [\"_app/immutable/assets/8.5GKuKWhi.css\"];\nexport const fonts = [];\n"],"names":[],"mappings":"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"}